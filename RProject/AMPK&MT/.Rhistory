view(degs)
View(degs)
#结果筛选padj<0.05 & abs(log2FoldChange)>=1
degs <- filter(res1,padj<0.05 & abs(log2FoldChange)>=0.5)#筛选padj<0.05及abs(log2FoldChange)>=1的基因
View(degs)
load("E:/scleraBioinformaticsAnalysis/Datasets/3_Myopia_Tissues/High/GSE280609/GSE280609_core_genes.rda")
View(AMPK_genes_DEG)
View(OXPHOS_genes_DEG)
View(res)
View(res1)
View(degs)
#绘制离散图
plotDispEsts(dds)
#p值直方图,直观看下p值显著基因的多少
hist(res$padj)
library(ggplot2)
library(cowplot)
library(ggrepel)
log2FoldChange <- 1
type1 = (res1$padj < 0.05)&(res1$log2FoldChange < -log2FoldChange)
type2 = (res1$padj < 0.05)&(res1$log2FoldChange > log2FoldChange)
res1$change = ifelse(type1,"DOWN",ifelse(type2,"UP","NOT"))
res1 <- res1[!is.na(res1$change),]
write.table(res1, file='DEG2.txt',sep = "\t",row.names = T,col.names = NA,quote = F)
table(res1$change)
View(res1)
DEG <- mutate(res1,Gene_symbol=row.names(res1))
UPDEG <- subset(DEG,change=='UP')
UPDEG_5 <- top_n(x = UPDEG,n = -5,wt = padj)
DOWNDEG <- subset(DEG,change=='DOWN')
DOWNDEG_5 <- top_n(x = DOWNDEG,n = -5,wt = padj)
p <- ggplot(data = DEG,
aes(x = log2FoldChange,
y = -log10(padj))) +
geom_point(alpha = 0.5, size = 4.5,
aes(color = change)) +
ylab("-log10(padj)") +
scale_color_manual(values = c("#1F77B4", "grey", "#FF7F0E")) +
geom_vline(xintercept = c(-1, 1), lty = 5, col = "black", lwd = 0.5) +
geom_hline(yintercept = -log10(0.05), lty = 4, col = "black", lwd = 0.5) +
theme_half_open() +
# 使用 geom_text_repel 避免文本重叠，并设置文本在点上方
geom_text_repel(data = UPDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y") +  # 限制文本只在垂直方向排列
geom_text_repel(data = DOWNDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y")  # 限制文本只在垂直方向排列
p
p <- ggplot(data = DEG,
aes(x = log2FoldChange,
y = -log10(padj))) +
geom_point(alpha = 0.5, size = 4.5,
aes(color = change)) +
ylab("-log10(padj)") +
scale_color_manual(values = c("blue", "grey", "pink")) +
geom_vline(xintercept = c(-1, 1), lty = 5, col = "black", lwd = 0.5) +
geom_hline(yintercept = -log10(0.05), lty = 4, col = "black", lwd = 0.5) +
theme_half_open() +
# 使用 geom_text_repel 避免文本重叠，并设置文本在点上方
geom_text_repel(data = UPDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y") +  # 限制文本只在垂直方向排列
geom_text_repel(data = DOWNDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y")  # 限制文本只在垂直方向排列
p
p <- ggplot(data = DEG,
aes(x = log2FoldChange,
y = -log10(padj))) +
geom_point(alpha = 0.5, size = 4.5,
aes(color = change)) +
ylab("-log10(padj)") +
scale_color_manual(values = c("blue", "grey", "red")) +
geom_vline(xintercept = c(-1, 1), lty = 5, col = "black", lwd = 0.5) +
geom_hline(yintercept = -log10(0.05), lty = 4, col = "black", lwd = 0.5) +
theme_half_open() +
# 使用 geom_text_repel 避免文本重叠，并设置文本在点上方
geom_text_repel(data = UPDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y") +  # 限制文本只在垂直方向排列
geom_text_repel(data = DOWNDEG_5, aes(label = Gene_symbol), vjust = 1.5, size = 3,
box.padding = unit(0.35, "lines"),
point.padding = unit(0.35, "lines"),
segment.color = 'grey50',
nudge_y = 0.1,  # 垂直向上移动文本
direction = "y")  # 限制文本只在垂直方向排列
p
vst <- vst(dds,blind = F)
exp1 <- assay(vst)
range(exp1)
exp1 <- as.data.frame(exp1)
save(exp,exp1,rt,file = 'GSE280609.rda')
rm(list=ls())
load('GSE309139.rda')
load('GSE280609.rda')
View(exp)
View(exp1)
View(exp1)
range(exp1)
DEG <- read.table("DEG2.txt",sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = 1)
View(DEG)
diff(DEG,exp1)
#2.热图####
library(pheatmap)
identical(rownames(rt),colnames(exp))
DEG <- read.table("DEG2.txt",sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = 1)
table(DEG$change)
diff <- rownames(DEG)[DEG$change !="NOT"]
exp_diff <- exp[diff,]
range(exp_diff)
pheatmap(exp_diff,
annotation_col=rt,
color = colorRampPalette((c("blue","white","red")))(100),
cluster_cols = F,
cluster_rows = T,
show_colnames = F,
show_rownames = T ,
border_color = NA,
scale='row') #scale='row' 进行标准化
diff =  DEG[DEG$change !="NOT",]
up <- diff %>% top_n(25,logFC)
diff =  DEG[DEG$change !="NOT",]
up <- diff %>% top_n(25,log2FoldChange)
dw <- diff %>% top_n(-25,log2FoldChange)
all <-c(rownames(up),rownames(dw))
exp_diff2 <- exp[all,]
pdf(file = 'heatmap2.pdf',width=6,height=8)
pheatmap(exp_diff2,
annotation_col=rt,
color = colorRampPalette((c("blue","white","red")))(100),
cluster_cols = F,
cluster_rows = F,
show_colnames = F,
show_rownames = T,
border_color = NA,
scale='row') #scale='row' 进行标准化
dev.off()
dev.off()
pdf(file = 'heatmap2.pdf',width=6,height=8)
pheatmap(exp_diff2,
annotation_col=rt,
color = colorRampPalette((c("blue","white","red")))(100),
cluster_cols = F,
cluster_rows = F,
show_colnames = F,
show_rownames = T,
border_color = NA,
scale='row') #scale='row' 进行标准化
dev.off()
rm(list = ls())
library(tidyverse)
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(ggplot2)
DEG <- read.table("DEG2.txt",sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = 1)
table(DEG$change)
diff <- rownames(DEG)[DEG$change!='NOT']
#将基因ID从Symbol转换为EntrezID
gene_entrez <- bitr(diff, fromType ="SYMBOL", toType ="ENTREZID", OrgDb = org.Hs.eg.db)
#可以查看一下转换比
cat("所有基因ID转换", nrow(gene_entrez),"/", length(diff))
untrans <- setdiff(diff, gene_entrez$SYMBOL)
untrans
# 使用mapIds函数转换
library(AnnotationDbi)
entrez_ids <- mapIds(
x = org.Hs.eg.db,
keys = untrans,       # 输入的基因别名列表
keytype = "ALIAS",    # 明确指定输入类型为别名
column = "ENTREZID",  # 转换为ENTREZID作为中间步骤
multiVals = "first"   # 多个匹配时取第一个
)
entrez_df <- data.frame(ENTREZID = entrez_ids, check.names = FALSE)
View(entrez_df)
entrez_df <- na.omit(entrez_df)
entrez_df <- entrez_df %>% rownames_to_column(var = 'SYMBOL')
#合并
gene_entrez2 <- rbind(gene_entrez,entrez_df)
untrans <- setdiff(diff, gene_entrez$SYMBOL)
#可以查看一下转换比
cat("所有基因ID转换", nrow(gene_entrez),"/", length(diff))
#可以查看一下转换比
cat("所有基因ID转换", nrow(gene_entrez2),"/", length(diff))
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.05,
qvalueCutoff =0.05,readable = T)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(GO_res)
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.5,
qvalueCutoff =0.5,readable = T)
View(GO_res)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(GO_res)
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.1,
qvalueCutoff =0.1,readable = T)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(GO_res)
#1.GO富集####
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.1,
qvalueCutoff =0.2,readable = T)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(GO_res)
#1.GO富集####
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.5,
qvalueCutoff =0.5,readable = T)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(GO_res)
GO <- enrichGO(gene = gene_entrez2$ENTREZID,
OrgDb = org.Hs.eg.db,
keyType ="ENTREZID",
ont ="ALL", # "BP", "MF", "CC"或"ALL"
pAdjustMethod ="BH",
pvalueCutoff =0.4,
qvalueCutoff =0.4,readable = T)
GO_res <- GO@result
write.table(GO_res,file="GO_res.txt",sep="\t",quote=F,row.names = F)
View(gene_entrez2)
barplot(GO, showCategory = 5,,split="ONTOLOGY") +
facet_grid(ONTOLOGY~., scale='free')
grep("mito", GO_res$Description)
GO_res$Description[grep("mito", GO_res$Description)]
GO_select <- GO_res$Description[grep("mito", GO_res$Description)]
barplot(GO, showCategory = GO_select,,split="ONTOLOGY") +
facet_grid(ONTOLOGY~., scale='free')
GO_select1 <- GO_res$Description[GO_res$p.adjust<0.4]
intersect(GO_select,GO_select1)
GO_select1 <- GO_res$Description[GO_res$p.adjust<0.3]
intersect(GO_select,GO_select1)
barplot(GO, showCategory = intersect(GO_select,GO_select1),,split="ONTOLOGY") +
facet_grid(ONTOLOGY~., scale='free')
GO_select1 <- GO_res$Description[GO_res$p.adjust<0.25]
barplot(GO, showCategory = intersect(GO_select,GO_select1),,split="ONTOLOGY") +
facet_grid(ONTOLOGY~., scale='free')
KEGG <- enrichKEGG(gene = gene_entrez2$ENTREZID,
organism     = 'hsa',
pvalueCutoff = 0.05,
qvalueCutoff =0.05)
KEGG_res <- KEGG@result
write.table(KEGG_res,file="KEGG_res.txt",sep="\t",quote=F,row.names = F)
View(KEGG_res)
dotplot(KEGG, showCategory = 20)
DEG <- read.table("DEG2.txt",sep = "\t",check.names = F, stringsAsFactors = F,header = T,row.names = 1)
DEG <- mutate(DEG,Gene_symbol=rownames(DEG))
KEGG_res <- read.table("KEGG_res.txt", sep = "\t",header = TRUE, stringsAsFactors = FALSE)
#KEGG <- setReadable(KEGG, OrgDb = org.Mm.eg.db, keyType = "ENTREZID")
#KEGG_res <- KEGG@result
kegg_select <- KEGG_res[KEGG_res$Description %in% c("AMPK signaling pathway","Oxidative phosphorylation"),]
kegg_list <- strsplit(kegg_select$geneID, "/")
## 构建 Term-Gene
n <- nrow(kegg_select)
a11 <- do.call(
rbind,
lapply(seq_len(n), function(i) {
data.frame(
Term  = kegg_select$Description[i],
gene  = kegg_list[[i]],
stringsAsFactors = FALSE
)
})
)
a11$value <- 1
a12 <- spread(a11, key = "Term", value = "value", fill = 0)
rownames(a12) <- a12$gene
a12 <- a12[, -1, drop = FALSE]
## 取交集并按 logFC 排序
id <- intersect(rownames(a12), DEG$Gene_symbol)
DEG2 <- DEG[id, , drop = FALSE]
DEG2 <- DEG2[order(DEG2$log2FoldChange, decreasing = TRUE), , drop = FALSE]
a12 <- a12[rownames(DEG2), , drop = FALSE]
a12$logFC <- DEG2$log2FoldChange
##绘制弦图
GOChord(
a12,
space        = 0.001,     # 基因之间的间距
gene.order   = "logFC", # 按 logFC 对基因排序
gene.space   = 0.25,    # 基因名跟圆圈的相对距离
gene.size    = 3,       # 基因名字体大小
border.size  = 0.1,     # 线条粗细
process.label= 8        # term 字体大小
)
library(GOplot)
library(ggplot2)
library(tidyr)
##绘制弦图
GOChord(
a12,
space        = 0.001,     # 基因之间的间距
gene.order   = "logFC", # 按 logFC 对基因排序
gene.space   = 0.25,    # 基因名跟圆圈的相对距离
gene.size    = 3,       # 基因名字体大小
border.size  = 0.1,     # 线条粗细
process.label= 8        # term 字体大小
)
GOChord(
a12,
space        = 0.001,     # 基因之间的间距
gene.order   = "logFC", # 按 logFC 对基因排序
gene.space   = 0.25,    # 基因名跟圆圈的相对距离
gene.size    = 3,       # 基因名字体大小
border.size  = 0.1,     # 线条粗细
process.label= 8        # term 字体大小
)
View(a12)
View(DEG)
View(a11)
View(KEGG_res)
View(KEGG)
KEGG <- setReadable(KEGG, OrgDb = org.Mm.eg.db, keyType = "ENTREZID")
library(tidyverse)
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(ggplot2)
KEGG <- setReadable(KEGG, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")
KEGG_res <- KEGG@result
kegg_select <- KEGG_res[KEGG_res$Description %in% c("AMPK signaling pathway","Oxidative phosphorylation"),]
kegg_list <- strsplit(kegg_select$geneID, "/")
View(kegg_list)
## 构建 Term-Gene
n <- nrow(kegg_select)
a11 <- do.call(
rbind,
lapply(seq_len(n), function(i) {
data.frame(
Term  = kegg_select$Description[i],
gene  = kegg_list[[i]],
stringsAsFactors = FALSE
)
})
)
a11$value <- 1
a12 <- spread(a11, key = "Term", value = "value", fill = 0)
rownames(a12) <- a12$gene
a12 <- a12[, -1, drop = FALSE]
## 取交集并按 logFC 排序
id <- intersect(rownames(a12), DEG$Gene_symbol)
DEG2 <- DEG[id, , drop = FALSE]
DEG2 <- DEG2[order(DEG2$log2FoldChange, decreasing = TRUE), , drop = FALSE]
a12 <- a12[rownames(DEG2), , drop = FALSE]
a12$logFC <- DEG2$log2FoldChange
##绘制弦图
GOChord(
a12,
space        = 0.001,     # 基因之间的间距
gene.order   = "logFC", # 按 logFC 对基因排序
gene.space   = 0.25,    # 基因名跟圆圈的相对距离
gene.size    = 3,       # 基因名字体大小
border.size  = 0.1,     # 线条粗细
process.label= 8        # term 字体大小
)
View(DEG)
library(enrichplot)
library(clusterProfiler)
library(org.Hs.eg.db)
#转换ENTREZID
# genelist <- bitr(DEG$Gene, fromType="SYMBOL",
#                  toType="ENTREZID", OrgDb='org.Hs.eg.db')
# DEG <- inner_join(DEG,genelist,by=c("Gene"="SYMBOL"))
geneList <- DEG[,2]
names(geneList) <- as.character(DEG[,'Gene'])
#排序
geneList <- sort(geneList, decreasing = TRUE)
geneList
names(geneList) <- as.character(DEG[,'Gene_symbol'])
#排序
geneList <- sort(geneList, decreasing = TRUE)
geneList
#读取gmt文件
gmt <- read.gmt('h.all.v2025.1.Hs.symbols.gmt')
#读取gmt文件
gmt <- read.gmt('h.all.v2026.1.Hs.symbols.gmt')
GSEA <- GSEA(geneList,
TERM2GENE = gmt,
pvalueCutoff = 0.05,
pAdjustMethod = "BH",
minGSSize = 20,
maxGSSize = 500)
res <- GSEA@result
write.csv(res,file = 'H_GSEA.csv')
View(res)
View(DEG)
load('GSE260609.rda')
load('GSE280609.rda')
rt <- rt3
str(exp)
exp <- exp %>% mutate(across(everything(), as.numeric))
str(exp)
#确认行名列名一致#确认行名列名一致
identical(rownames(rt),colnames(exp))
#提取 自定义基因,整理高低表达组
rt1 <- as.data.frame(t(exp['PTPRC',]))
#提取 自定义基因,整理高低表达组
rt1 <- as.data.frame(t(exp['PRKAA1',]))
View(rt1)
rt1$group <- ifelse(rt1$PTPRC > median(rt1$PTPRC),'up','down')
View(rt1)
#提取 自定义基因,整理高低表达组
rt1 <- as.data.frame(t(exp['PRKAA1',]))
View(rt1)
rt1$group <- ifelse(rt1$PRKAA1 > median(rt1$PRKAA1),'up','down')
View(rt1)
rt1 <- arrange(rt1,'PRKAA1',group)
identical(rownames(rt1),colnames(exp))
exp <- exp[,rownames(rt1)]
identical(rownames(rt1),colnames(exp))
View(exp)
# [1] TRUE
#组间差异分析
group_list <- factor(rt1$group,levels = c("down","up"))
group_list
design <- model.matrix(~group_list)
#比较矩阵命名
design
#线性模型拟合
fit <- lmFit(exp,design)
library(limma)
#线性模型拟合
fit <- lmFit(exp,design)
#贝叶斯检验
fit2 <- eBayes(fit)
View(exp)
View(DEG)
dds <- DESeqDataSetFromMatrix(
countData = exp,
colData = rt,
design = ~ group
)
#进行低表达基因过滤(自定义)
filter <- rowSums(counts(dds)) > 1  # 筛选每行加起来大于1的基因
dds <- dds[filter, ]
#差异表达分析
dds <- DESeq(dds)
#指定具体的对比组，格式为c("因子名", "实验组", "对照组")
res <- results(dds, contrast = c("group", "myopia", "control"))
#提取差异表达结果
res1 <- as.data.frame(res)
View(res1)
View(DEG)
#转换ENTREZID
# genelist <- bitr(DEG$Gene, fromType="SYMBOL",
#                  toType="ENTREZID", OrgDb='org.Hs.eg.db')
# DEG <- inner_join(DEG,genelist,by=c("Gene"="SYMBOL"))
geneList <- DEG[,2]
names(geneList) <- as.character(DEG[,'Gene_symbol'])
#排序
geneList <- sort(geneList, decreasing = TRUE)
geneList
#读取gmt文件
gmt <- read.gmt('c2.cp.kegg_medicus.v2025.1.Hs.symbols.gmt')
#读取gmt文件
gmt <- read.gmt('c2.cp.kegg_medicus.v2026.1.Hs.symbols.gmt')
GSEA <- GSEA(geneList,
TERM2GENE = gmt,
pvalueCutoff = 0.05, #改成1获得全部结果
pAdjustMethod = "BH",
minGSSize = 20,
maxGSSize = 500)
res <- GSEA@result
write.csv(res,file = 'KEGG_GSEA.csv')
View(res)
p <- gseaplot2(GSEA,geneSetID = 'KEGG_MEDICUS_REFERENCE_COPI_VESICLE_FORMATION',
title = 'KEGG_MEDICUS_REFERENCE_COPI_VESICLE_FORMATION',color = 'red')
p
p <- gseaplot2(GSEA,geneSetID = 'KEGG_MEDICUS_REFERENCE_COPI_VESICLE_FORMATION',
title = 'KEGG_MEDICUS_REFERENCE_COPI_VESICLE_FORMATION',color = 'red')
p
